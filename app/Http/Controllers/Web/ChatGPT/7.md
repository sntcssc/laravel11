Sure! Below is a complete controller code for your multi-step form, including dynamic validation, data handling for multiple records, file uploads, and final review/preview before submission.

### **StudentFormController.php**

```php
<?php

namespace App\Http\Controllers;

use App\Models\Student;
use App\Models\StudentDetail;
use App\Models\PreparationDetail;
use App\Models\SourcesUsed;
use App\Models\CsatPreparation;
use App\Models\AdditionalPreparation;
use App\Models\PersonalityDetail;
use App\Models\SfgProgramKnowledge;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class StudentFormController extends Controller
{
    // Show the form step (step number passed as parameter)
    public function showForm($step)
    {
        try {
            $student = Auth::user();

            // Get data based on the current step
            switch ($step) {
                case 1:
                    $studentDetail = $student->studentDetails()->first();
                    return view('student.step1', compact('studentDetail'));
                case 2:
                    $preparationDetail = $student->preparationDetails()->first();
                    return view('student.step2', compact('preparationDetail'));
                case 3:
                    $sourcesUsed = $student->sourcesUseds()->first();
                    return view('student.step3', compact('sourcesUsed'));
                case 4:
                    $csatPreparation = $student->csatPreparations()->first();
                    return view('student.step4', compact('csatPreparation'));
                case 5:
                    $additionalPreparation = $student->additionalPreparations()->first();
                    return view('student.step5', compact('additionalPreparation'));
                case 6:
                    $personalityDetail = $student->personalityDetails()->first();
                    return view('student.step6', compact('personalityDetail'));
                case 7:
                    $sfgProgramKnowledge = $student->sfgProgramKnowledges()->first();
                    return view('student.step7', compact('sfgProgramKnowledge'));
                case 8:
                    return redirect()->route('student.preview'); // Go to preview after last step
                default:
                    return redirect()->route('student.form', ['step' => 1]); // Default to step 1 if invalid step
            }
        } catch (\Exception $e) {
            return redirect()->route('student.form', ['step' => 1])->with('error', 'An error occurred.');
        }
    }

    // Submit the data for each step
    public function submitStep(Request $request, $step)
    {
        try {
            // Dynamically validate based on the step
            $validationRules = $this->getStepValidationRules($step);
            $validated = $request->validate($validationRules);

            // Process the step and save data
            switch ($step) {
                case 1:
                    $this->submitStep1($request);
                    break;
                case 2:
                    $this->submitStep2($request);
                    break;
                case 3:
                    $this->submitStep3($request);
                    break;
                case 4:
                    $this->submitStep4($request);
                    break;
                case 5:
                    $this->submitStep5($request);
                    break;
                case 6:
                    $this->submitStep6($request);
                    break;
                case 7:
                    $this->submitStep7($request);
                    break;
                default:
                    return redirect()->route('student.form')->with('error', 'Invalid Step');
            }

            // Save current step in session to show progress
            session(['current_step' => $step + 1]);
            return redirect()->route('student.form', ['step' => $step + 1]);

        } catch (\Exception $e) {
            return back()->withErrors(['error' => 'An error occurred while submitting the data.']);
        }
    }

    // Dynamic validation rules for each step
    protected function getStepValidationRules($step)
    {
        switch ($step) {
            case 1:
                return [
                    'first_name' => 'required|string|max:255',
                    'last_name' => 'required|string|max:255',
                    'dob' => 'required|date',
                    'photo' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:2048',
                ];
            case 2:
                return [
                    'highest_education_qualification' => 'required|string|max:255',
                    'graduation_subject' => 'required|string|max:255',
                    'optional_subject' => 'nullable|string|max:255',
                ];
            case 3:
                return [
                    'subject' => 'required|string|max:255',
                    'source_material' => 'required|string|max:255',
                ];
            case 4:
                return [
                    'isever_failed_csat' => 'required|boolean',
                    'failed_csat_count' => 'nullable|integer',
                    'difficult_csat_section' => 'nullable|string|max:255',
                    'took_csat_coaching' => 'required|boolean',
                    'mock_test_for_csat' => 'required|boolean',
                    'practicing_csat_every_day' => 'required|boolean',
                ];
            case 5:
                return [
                    'youtube_channels_followed' => 'nullable|string|max:255',
                    'other_coaching_programs' => 'nullable|string|max:255',
                ];
            case 6:
                return [
                    'reason_for_civil_services' => 'required|string|max:500',
                    'essential_values_for_topping' => 'required|string|max:500',
                    // Other personality-related fields
                ];
            case 7:
                return [
                    'key_features_of_sfg_program' => 'required|string|max:500',
                    'ways_sfg_will_help_in_exam' => 'required|string|max:500',
                    // Other SFG Program knowledge-related fields
                ];
            default:
                return [];
        }
    }

    // Save data for Step 1 (Personal Information)
    public function submitStep1(Request $request)
    {
        $student = Auth::user();

        // Handle file upload if exists
        if ($request->hasFile('photo')) {
            $request->validate(['photo' => 'image|mimes:jpeg,png,jpg,gif|max:2048']);
            $photoPath = $request->file('photo')->store('photos', 'public');
        }

        $studentDetail = $student->studentDetails()->firstOrNew(['student_id' => $student->id]);
        $studentDetail->first_name = $request->first_name;
        $studentDetail->last_name = $request->last_name;
        $studentDetail->dob = $request->dob;
        $studentDetail->photo = $photoPath ?? $studentDetail->photo;
        $studentDetail->save();
    }

    // Save data for Step 2 (Preparation Details)
    public function submitStep2(Request $request)
    {
        $student = Auth::user();
        $preparationDetail = $student->preparationDetails()->firstOrNew(['student_id' => $student->id]);
        $preparationDetail->highest_education_qualification = $request->highest_education_qualification;
        $preparationDetail->graduation_subject = $request->graduation_subject;
        $preparationDetail->optional_subject = $request->optional_subject;
        $preparationDetail->save();
    }

    // Save data for Step 3 (Sources Used)
    public function submitStep3(Request $request)
    {
        $student = Auth::user();
        $sourcesUsed = $student->sourcesUseds()->firstOrNew(['student_id' => $student->id]);
        $sourcesUsed->subject = $request->subject;
        $sourcesUsed->source_material = $request->source_material;
        $sourcesUsed->save();
    }

    // Save data for Step 4 (CSAT Preparation)
    public function submitStep4(Request $request)
    {
        $student = Auth::user();
        $csatPreparation = $student->csatPreparations()->firstOrNew(['student_id' => $student->id]);
        $csatPreparation->isever_failed_csat = $request->isever_failed_csat;
        $csatPreparation->failed_csat_count = $request->failed_csat_count;
        $csatPreparation->difficult_csat_section = $request->difficult_csat_section;
        $csatPreparation->took_csat_coaching = $request->took_csat_coaching;
        $csatPreparation->mock_test_for_csat = $request->mock_test_for_csat;
        $csatPreparation->practicing_csat_every_day = $request->practicing_csat_every_day;
        $csatPreparation->save();
    }

    // Save data for Step 5 (Additional Preparation)
    public function submitStep5(Request $request)
    {
        $student = Auth::user();
        $additionalPreparation = $student->additionalPreparations()->firstOrNew(['student_id' => $student->id]);
        $additionalPreparation->youtube_channels_followed = $request->youtube_channels_followed;
        $additionalPreparation->other_coaching_programs = $request->other_coaching_programs;
        $additionalPreparation->save();
    }

    // Save data for Step 6 (Personality Detail)
    public function submitStep6(Request $request)
    {
        $student = Auth::user();
        $personalityDetail = $student->personalityDetails()->firstOrNew(['student_id' => $student->id]);
        $personalityDetail->reason_for_civil_services = $request->reason_for_civil_services;
        $personalityDetail->essential_values_for_topping = $request->essential_values_for_topping;
        // Add more personality-related fields
        $personalityDetail->save();
    }

    // Save data for Step 7 (SFG Program Knowledge)
    public function submitStep7(Request $request)
    {
        $student = Auth::user();
        $sfgProgramKnowledge = $student->sfgProgramKnowledges()->firstOrNew(['student_id' => $student->id]);
        $sfgProgramKnowledge->key_features_of_sfg_program = $request->key_features_of_sfg_program;
        $sfgProgramKnowledge->ways_sfg_will_help_in_exam = $request->ways_sfg_will_help_in_exam;
        // Add more SFG program-related fields
        $sfgProgramKnowledge->save();
    }

    // Show the final review/preview page
    public function preview()
    {
        $student = Auth::user();
        $studentDetails = $student->studentDetails()->first();
        $preparationDetails = $student->preparationDetails()->first();
        $sourcesUsed = $student->sourcesUseds()->first();
        $csatPreparation = $student->csatPreparations()->first();
        $additionalPreparation = $student->additionalPreparations()->first();
        $personalityDetail = $student->personalityDetails()->first();
        $sfgProgramKnowledge = $student->sfgProgramKnowledges()->first();

        return view('student.preview', compact(
            'studentDetails', 'preparationDetails', 'sourcesUsed', 
            'csatPreparation', 'additionalPreparation', 'personalityDetail', 
            'sfgProgramKnowledge'
        ));
    }

    // Final form submission
    public function submitFinal(Request $request)
    {
        $validated = $request->validate([
            'terms_agreed' => 'required|accepted',
        ]);

        // Mark the form as completed or perform any other necessary actions
        session()->forget('current_step'); // Reset the form process session
        return redirect()->route('student.form')->with('success', 'Form submitted successfully!');
    }
}
```

### **Key Features in the Controller**

1. **Dynamic Step Handling**: Based on the step number passed in the route, the controller shows the correct form view and processes the form submission accordingly.
2. **Validation**: Validation rules are defined dynamically for each step to ensure all fields are filled properly before moving to the next step.
3. **File Handling**: If the student uploads a photo, it is stored and linked to the `StudentDetail` record.
4. **Multiple Records**: For each step, the relevant model (e.g., `StudentDetail`, `PreparationDetail`, etc.) is updated or created using `firstOrNew`.
5. **Preview and Final Submission**: Students can review their entered details on the final preview page and submit the form after agreeing to the terms.

---

This code should be implemented in your Laravel controller and linked to your routes and views accordingly. Let me know if you need any further adjustments!